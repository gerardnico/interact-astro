// src/config/index.ts
import path from 'path';
import {readFile} from 'fs/promises';
import {type Config, ConfigSchema, FaviconSetSchemaType} from "./configSchema";
import {z} from 'astro/zod';
import fs from 'fs'

/**
 * Configuration source information
 */
export interface ConfigSource {
    config: Config;
    loaded: boolean;
}


export const configFileName = 'interact.config.json';



// Based on https://realfavicongenerator.net
let defaultFavicons: FaviconSetSchemaType = {
    "favicon.ico": {
        rel: "shortcut icon",
    },
    "favicon-96x96.png": {
        rel: "icon",
        image: {
            type: "image/png",
            width: 96,
            height: 96
        }
    },
    "favicon.svg": {
        rel: "icon",
        image: {
            type: "image/svg+xml"
        }
    },
    "apple-touch-icon.png": {
        rel: "apple-touch-icon",
        image: {
            width: 180,
            height: 180
        }
    }
};

function updateFavicon(favicons: FaviconSetSchemaType): FaviconSetSchemaType {
    if(!favicons){
        favicons={}
    }
    for (let [faviconName, faviconProperties] of Object.entries(defaultFavicons)) {
        if (faviconName in Object.keys(favicons)) {
            continue
        }
        if (fs.existsSync(`public/${faviconName}`)) {
            favicons[faviconName] = faviconProperties
        }
    }
    return favicons;
}

/**
 * Load configuration with fallback to defaults
 */
async function loadConfig(): Promise<ConfigSource> {


    let configFile = path.join(process.cwd(), `${configFileName}`);
    let configContent: string;
    try {
        // Try to import the config file
        configContent = await readFile(configFile, 'utf-8');
    } catch (error) {
        if (error.code === 'ENOENT') {
            // Config file doesn't exist
            console.warn(`No ${configFile} found, using default configuration`);
            return {
                config: ConfigSchema.parse({}),
                loaded: false,
            };
        }
        console.error(`Unexpected error ${error.code} while reading the config file: ${configFile}`);
        throw error;
    }
    console.log(`${configFile} found`);
    let data: Object;
    try {
        data = JSON.parse(configContent)
    } catch (error) {
        console.error(`The config file is not a valid Json file: ${configFile}`);
        console.error(`Error: ${error.message}`);
        throw error;
    }
    const result = ConfigSchema.safeParse(data);
    if (!result.success) {
        let errorMessage = result.error.issues
            .map(issue => {
                const path = issue.path.join('.');
                return `â€¢ ${path}: ${issue.message}`;
            })
            .join('\n');
        console.error('Configuration errors:\n' + errorMessage);
        // noinspection ExceptionCaughtLocallyJS
        throw new Error("Configuration error")
    }

    result.data.theme.site.favicons = updateFavicon(result.data.theme.site.favicons);
    return {
        config: result.data,
        loaded: true,
    };


}

// Export the config source information
export const configResult = await loadConfig();

// Export just the config for convenience
// noinspection JSUnusedGlobalSymbols
export const config = configResult.config;
export const themeConfig = configResult.config.theme;
export default themeConfig;
// noinspection JSUnusedGlobalSymbols
export const loaded = configResult.loaded;

